# (todo 未完成) CSS优先级，没你想的那么简单！全面介绍影响CSS优先级的属性

（todo 待选标题 CSS优先级，没你想的那么简单！选择器/类/继承/内联/默认样式/@layer/@import/important/:where()/动画/过渡等等... ）

## 目录
[[toc]]

## 简介
提到CSS优先级，我们首先会想到各类的选择器，例如ID选择器，类选择器，元素选择器等等。这些选择器有不同的优先级分数，可以根据得分轻松判断出CSS样式的优先级。

但是CSS优先级真的这么简单么？其实不是。在实践中，有很多很多会覆盖CSS样式或者改变优先级顺序的语法和现象，CSS优先级的判断实际上是非常复杂的。有如下这些主题会实际影响到CSS优先级的表现：

- CSS属性顺序
- 各种选择器和组合：ID选择器，类选择器，元素选择器等
- CSS属性继承
- 内联CSS属性
- 层叠层 @layer
- 嵌套层叠层
- 浏览器默认样式
- 用户自定义样式
- !important声明
- CSS属性默认值
- 正在动画的样式
- 正在过渡的样式
- 引入样式 @import
- :where()和:is()和:not()选择器
- all属性

(todo 找更多的影响点, 这里待调整)

下面我们就来分别聊一下，这些主题是如何影响到CSS优先级的。

## CSS浏览器调试
在描述具体的优先级规则之前，我们先来看一下在页面上如何确定生效的是哪个CSS，以及如何调试CSS。

对于我们学习CSS优先级来说，在页面上如何确定生效的是哪个CSS是很容易的：我们只要设置一些非常明显的CSS样式即可，例如背景颜色，字体颜色等。不同的代码控制的颜色不同，即可很明显的看到是哪段代码生效。但是在实践中，有部分不容易直接观察到的CSS，或者有一定的触发条件，这时候使用浏览器调试功能，可以更方便的查看和调试CSS。

例如在Chrome浏览器中，我们在页面上右键点击想要查看的区域，选择检查，在调试面板中选择Elements，即可看到对应的HTML标签和CSS样式。

![](/2024/css-1.png)

在右侧的Style中，我们可以看到不同选择器的样式规则和生效情况，以及内联样式，甚至是用户代理样式（浏览器默认样式），和继承样式等，右侧还给出了代码来源。

![](/2024/css-2.png)

把鼠标放到选择器上，可以看到选择器具体的优先级数值。而那些画了删除线的样式，则是因为优先级低而不生效的样式。

![](/2024/css-3.png)

我们可以任意修改样式，查看效果，甚至可以新增或者删除样式。点击任意选择器，会出现新增属性的输入位置。点击任意属性，会发现属性key和值都可以变为编辑态。而且属性前会出现一个checkbox，取消勾中则该属性就不生效了。如果该属性恰好覆盖了其他属性，当取消勾中时，之前被覆盖属性的删除线会消失，属性变为生效状态。

![](/2024/css-4.png)

通过这些工具可以轻松的验证CSS属性的优先级和生效情况。当然，浏览器中CSS相关的调试工具还有很多，这里就不一一介绍了。

## CSS前后顺序

CSS属性顺序是一个很容易理解，但也很重要的一条规则。最所以最早描述，是因为这条规则影响着其他所有的规则。而且不仅适用于属性，也适用于选择器，layer，import等有先后顺序的CSS规则。(todo 哪些和先后顺序有关)

这条规则就是： 如果有多个CSS规则，且其他规则指定的优先级相同，则后面出现的规则比前面出现的规则优先级高。

例如：
```css
p {
  color: blue;
}
p {
  color: green;
  color: red;
}
```

同样的两个元素选择器，后面的优先级就比前面的高。而在一个选择器中，对同一个属性进行赋值，也是后面的优先级更高。因此，在上述的代码中， 优先级实际为：`red > green > blue`。查看浏览器，可以看到具体的生效样式。

![](/2024/css-5.png)

把red禁用后，也可以看到下一个生效的是green。

## 各类选择器和组合

各类选择器和组合是我们平时接触最多的关于CSS优先级的内容。先来描述一下各种选择器的优先级。

### 选择器的优先级

选择器分为三个类别：

1. 元素选择器(`p`)和伪元素选择器(`::before`)
2. 类选择器(`.example`)，属性选择器(`[type="radio"]`)和伪类选择器(`:hover`)
3. ID选择器(`#example`)

在具体计算中，每一类选择器都对应一个权重分量：

他们的优先级是 第1类 < 第2类 < 第3类。对应的，优先级越高，实际上选择器越精确，例如ID选择器是唯一的，精确性最高。
类是开发者自己指定的，类选择器精确性一般比元素选择器要高。在具体计算中，每一类选择器都对应一个权重分量：

| 选择器类型 | 对应权重 |
| - | - |
| 元素选择器 | 0-0-1 |
| 类/属性选择器 | 0-1-0 |
| ID选择器 | 1-0-0 |

权重分量数值越大，表示优先级越高，例如 1-0-0 > 0-1-0 > 0-0-1。

### 组合选择器
假设一个选择器是由多个选择器组合而成的，那么这个选择器的优先级是其中各个选择器单独优先级的加和。不管使用哪种组合器甚至嵌套组合。（存在特殊情况，后面描述）例如：

| 选择器示例 | 组合器类型 | 包含选择器类型 | 对应权重和 |
| - | - | - | - |
| `#id` | 无 | 单个ID选择器 | 1-0-0 |
| `.a.b` | 交集选择器 | 两个类选择器 | 0-2-0 |
| `p>.a` | 直接子代选择器 | 元素选择器+类选择器 | 0-1-1 |
| `#id~.a [type="radio"]` | 兄弟组合器+后代组合器 | ID选择器+类选择器+属性选择器 | 1-2-0 |

通过计算单独选择器的加和，我们可以轻松的比较出各种选择器组合的优先级。可以看到，使用哪种组合选项器类型或者嵌套了多少层，都是不影响选择器的优先级的。

可以看到我们的选择器权重和是相加的，那么会不会有进位现象呢？即：
- 0-0-12 是否等于 0-1-2
- 0-21-0 是否大于 2-0-0

答案都是否：没有进位规则；而且低优先级的选择器无论出现多少个，优先级也不会比高优先级的选择器更高。这里的权重和可以在Chrome浏览器中观察到（见**CSS浏览器调试**一节）。

### 特殊的选择器
有部分特殊的选择器类型，和上面介绍的规则并不一致，我们来看一下：

**通用选择器 `*`**

通用选择器是可以选择所有元素的选择器，优先级为 0-0-0。这个优先级比上面介绍的任何选择器的优先级更低。

**并集选择器 `.a, .b`**

并集选择器也是一种组合选择器，是一个由逗号分隔的选择器列表，例如`.a, .b, p`。如果其中任意选择器与元素匹配，这个选择器组合即与该元素匹配。它的优先级规则和其他组合选择器不同：是由选择器列表中生效的优先级最高的选择器决定该选择器的优先级。我们来看一个例子：

```html
<body>
  <p id="ida" class="a b c">hello, jzplp</p>
</body>
<style>
  p, #idb.a.b.c, .a, .b.c {
    color: blue;
  }
  #ida {
    color:red;
  }
</style>
```

对于body中的p标签，我们分析下选择器的优先级情况。首先是`p, #idb.a.b.c, .a, .b.c`，我们把选择器列表拆开分析：

| 选择器 | 是否命中 | 权重和 |
| - | - | - |
| `p` | 是 | 0-0-1 |
| `#idb.a.b.c` | 否 | 1-3-0 |
| `.a` | 是 | 0-1-0 |
| `.b.c` | 是 | 0-2-0 |

然后是`#ida`选择器，成功命中，权重和为1-0-0。我们把这段代码放到浏览器中，可以看到生效的是`#ida`选择器。

![](/2024/css-6.png)

虽然并集选择器中优先级最高的为1-3-0，比`#ida`选择器更高，但在没命中的情况下并不生效，选贼的优先级是在生效的情况下比较。

### 总结

通过上面的描述，我们已经知道了基础的优先级比较原则，即根据权重和计算和比较得出。为什么这么设计，实际是遵循了一个原则：选择器越“精确”，优先级越高。这个原则不仅适用于上面的内容，对于后面提到的更多优先级规则也适用。

## 伪元素和伪类


## CSS嵌套


## 不会影响CSS优先级的内容


## 参考
- MDN CSS优先级\
  https://developer.mozilla.org/zh-CN/docs/Web/CSS/Specificity
- MDN CSS层叠、优先级与继承\
  https://developer.mozilla.org/zh-CN/docs/Learn/CSS/Building_blocks/Cascade_and_inheritance
- MDN CSS层叠层\
  https://developer.mozilla.org/zh-CN/docs/Learn/CSS/Building_blocks/Cascade_layers
- CSS specifishity with plankton, fish and sharks\
  https://specifishity.com/
- CSS中class的优先级\
  https://blog.csdn.net/yjjjjz/article/details/103240864
- MDN CSS 选择器\
  https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_selectors
- MDN CSS 伪类\
  https://developer.mozilla.org/zh-CN/docs/Web/CSS/Pseudo-classes
- MDN CSS 伪元素\
  https://developer.mozilla.org/zh-CN/docs/Web/CSS/Pseudo-elements
- MDN CSS all属性\
  https://developer.mozilla.org/zh-CN/docs/Web/CSS/all
- MDN CSS :where()伪类\
  https://developer.mozilla.org/zh-CN/docs/Web/CSS/:where
